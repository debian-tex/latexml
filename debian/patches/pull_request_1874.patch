From 878d10f02ab1173134369baa8e7ef5c820105703 Mon Sep 17 00:00:00 2001
From: Bruce Miller <nebconinc@gmail.com>
Date: Thu, 23 Jun 2022 09:25:33 -0400
Subject: [PATCH] Fix ordering error in \InputIfFileExists

---
 lib/LaTeXML/Package/LaTeX.pool.ltxml | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

--- latexml.orig/lib/LaTeXML/Package/LaTeX.pool.ltxml
+++ latexml/lib/LaTeXML/Package/LaTeX.pool.ltxml
@@ -4010,8 +4010,10 @@
 #======================================================================
 Let('\@@input', '\input');    # Save TeX's version.
                               # LaTeX's \input is a bit different...
+# Input, now
+DefPrimitive('\ltx@input {}', sub { Input(Expand($_[1])); });
 DefMacroI('\input', undef, '\@ifnextchar\bgroup\@iinput\@@input');
-DefPrimitive('\@iinput {}', sub { Input(Expand($_[1])); });
+Let('\@iinput', '\ltx@input');
 DefMacro('\@input{}',  '\IfFileExists{#1}{\@@input\@filef@und}{\typeout{No file #1.}}');
 DefMacro('\@input@{}', '\InputIfFileExists{#1}{}{\typeout{No file #1.}}');
 
@@ -5713,11 +5715,12 @@
 
 DefMacro('\InputIfFileExists{}{}{}', sub {
     my ($gullet, $file, $if, $else) = @_;
-    my $file_string = ToString(Expand($file));
+    $file = Expand($file);
+    my $file_string = ToString($file);
     if (FindFile($file_string)) {
       DefMacro('\@filef@und', '"' . $file_string . '" ');
-      Input($file_string);
-      return ($if->unlist); }
+      return Tokens($if, T_CS('\@addtofilelist'), T_BEGIN, $file, T_END,
+        T_CS('\ltx@input'), T_BEGIN, $file, T_END); }
     else { return ($else->unlist); } });
 
 #======================================================================
--- latexml.orig/t/80_complex.t
+++ latexml/t/80_complex.t
@@ -6,5 +6,5 @@
 
 latexml_tests("t/complex",
   requires => {
-     cleveref_minimal => 'cleveref.sty',
-     si => 'siunitx.sty' });
+    cleveref_minimal => 'cleveref.sty',
+    si               => { packages => 'siunitx.sty', texlive_min => 2015 } });
